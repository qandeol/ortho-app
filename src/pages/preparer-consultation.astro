---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Préparer Consultation | Ma Santé – Pied Cheville">
  <div class="max-w-4xl mx-auto space-y-8">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-900 mb-4">Préparer ma consultation</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Remplissez ce questionnaire pour savoir quoi dire lors de votre consultation. 
        Vos réponses resteront stockées localement sur votre téléphone.
      </p>
    </div>

    <!-- Formulaire -->
    <div class="bg-white rounded-xl shadow-soft p-8">
      <form id="consultationForm" class="space-y-6">
        <!-- Depuis quand -->
        <div>
          <label for="depuisQuand" class="block text-sm font-medium text-gray-700 mb-2">
            Depuis quand avez-vous ces symptômes ? Quelle fréquence ?
          </label>
          <div class="grid md:grid-cols-2 gap-4">
            <select id="depuisQuand" name="depuisQuand" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              <option value="">Sélectionnez une option</option>
              <option value="moins-1-semaine">Moins d'une semaine</option>
              <option value="1-4-semaines">1 à 4 semaines</option>
              <option value="1-3-mois">1 à 3 mois</option>
              <option value="3-6-mois">3 à 6 mois</option>
              <option value="plus-6-mois">Plus de 6 mois</option>
              <option value="plus-1-an">Plus d'un an</option>
            </select>
            <select id="frequence" name="frequence" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
              <option value="">Fréquence</option>
              <option value="ponctuel">Ponctuel</option>
              <option value="quotidien">Quotidien</option>
              <option value="plusieurs-fois-semaine">Plusieurs fois/semaine</option>
              <option value="hebdomadaire">Hebdomadaire</option>
              <option value="mensuel">Mensuel</option>
            </select>
          </div>
        </div>

        <!-- Type de douleur -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Type de douleur (mécanique / inflammatoire) ?
          </label>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="typeDouleur" value="mecanique" class="text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Mécanique (au mouvement)</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="typeDouleur" value="inflammatoire" class="text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Inflammatoire (au repos)</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="typeDouleur" value="mixte" class="text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Les deux</span>
              </label>
            </div>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="typeDouleur" value="nocturne" class="text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Nocturne</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="typeDouleur" value="matinale" class="text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Matinale</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Intensité -->
        <div>
          <label for="intensite" class="block text-sm font-medium text-gray-700 mb-2">
            Intensité de la douleur (0 = aucune, 10 = insupportable)
          </label>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-500">0</span>
            <input 
              type="range" 
              id="intensite" 
              name="intensite" 
              min="0" 
              max="10" 
              value="0"
              class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
            >
            <span class="text-sm text-gray-500">10</span>
            <span id="intensiteValue" class="text-lg font-semibold text-primary-600 min-w-[2rem] text-center">0</span>
          </div>
        </div>

        <!-- Déjà essayé -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Qu'avez-vous déjà essayé ?
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center">
              <input type="checkbox" name="traitements" value="kine" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-2 text-sm text-gray-700">Kinésithérapie</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="traitements" value="podologue" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-2 text-sm text-gray-700">Podologue</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="traitements" value="infiltration" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-2 text-sm text-gray-700">Infiltration</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="traitements" value="ains" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
              <span class="ml-2 text-sm text-gray-700">Anti-inflammatoires</span>
            </label>
          </div>
        </div>

        <!-- Antécédents & Allergies -->
        <div>
          <label for="antecedents" class="block text-sm font-medium text-gray-700 mb-2">
            Antécédents médicaux & Allergies
          </label>
          <textarea 
            id="antecedents" 
            name="antecedents" 
            rows="3" 
            placeholder="Décrivez vos antécédents médicaux, chirurgicaux et vos allergies..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          ></textarea>
        </div>

        <!-- Restrictions / Handicap -->
        <div>
          <label for="restrictions" class="block text-sm font-medium text-gray-700 mb-2">
            Restrictions / Handicap dans la vie quotidienne
          </label>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="marche" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Difficultés à marcher</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="sport" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Impossible de faire du sport</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="travail" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Impact sur le travail</span>
              </label>
            </div>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="chaussures" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Difficultés à porter des chaussures</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="escaliers" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Difficultés avec les escaliers</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="restrictions" value="repos" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="ml-2 text-sm text-gray-700">Douleur même au repos</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Ce qui aggrave -->
        <div>
          <label for="aggrave" class="block text-sm font-medium text-gray-700 mb-2">
            Qu'est-ce qui aggrave les choses ?
          </label>
          <textarea 
            id="aggrave" 
            name="aggrave" 
            rows="2" 
            placeholder="Décrivez les facteurs qui aggravent vos symptômes (mouvements, positions, activités...)"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          ></textarea>
        </div>

        <!-- Gêne & Objectifs -->
        <div>
          <label for="gene" class="block text-sm font-medium text-gray-700 mb-2">
            Gêne dans la vie quotidienne & Objectifs de traitement
          </label>
          <textarea 
            id="gene" 
            name="gene" 
            rows="3" 
            placeholder="Décrivez comment vos symptômes vous gênent et quels sont vos objectifs de traitement..."
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
          ></textarea>
        </div>

        <!-- Boutons d'action -->
        <div class="flex flex-wrap gap-4 pt-4">
          <button 
            type="button" 
            id="saveBtn"
            class="px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors"
          >
            Sauvegarder
          </button>
          <button 
            type="button" 
            id="clearBtn"
            class="px-6 py-3 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition-colors"
          >
            Effacer
          </button>
          <button 
            type="button" 
            id="printBtn"
            class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors"
          >
            Imprimer / PDF
          </button>
        </div>
      </form>
    </div>

    <!-- Aperçu -->
    <div id="apercu" class="bg-gray-50 rounded-xl p-6 hidden">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Aperçu de votre mémo</h3>
      <div id="apercuContent" class="prose prose-gray max-w-none">
        <!-- Le contenu sera généré par JavaScript -->
      </div>
    </div>

    <!-- Information de confidentialité -->
    <div class="bg-blue-50 rounded-xl p-6">
      <div class="flex items-start space-x-4">
        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-blue-900 mb-2">Confidentialité garantie</h3>
          <p class="text-blue-700">
            Vos réponses restent sur votre téléphone (aucune collecte en V1/V2). 
            Vous pouvez imprimer ce mémo pour l'apporter à votre consultation.
          </p>
        </div>
      </div>
    </div>

    <!-- Date de mise à jour -->
    <div class="text-center text-sm text-gray-500 pt-4">
      <p>Dernière mise à jour : 6 janvier 2025</p>
    </div>
  </div>

  <script>
    // Gestion du slider d'intensité
    const intensiteSlider = document.getElementById('intensite');
    const intensiteValue = document.getElementById('intensiteValue');
    
    intensiteSlider.addEventListener('input', function() {
      intensiteValue.textContent = this.value;
    });

    // Chargement des données sauvegardées
    function loadSavedData() {
      const savedData = localStorage.getItem('consultationMemo');
      if (savedData) {
        const data = JSON.parse(savedData);
        
        // Remplir le formulaire
        document.getElementById('depuisQuand').value = data.depuisQuand || '';
        document.getElementById('intensite').value = data.intensite || 0;
        intensiteValue.textContent = data.intensite || 0;
        document.getElementById('antecedents').value = data.antecedents || '';
        document.getElementById('gene').value = data.gene || '';
        
        // Cocher les cases
        if (data.traitements) {
          data.traitements.forEach(traitement => {
            const checkbox = document.querySelector(`input[value="${traitement}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }
        
        updateApercu();
      }
    }

    // Sauvegarde des données
    function saveData() {
      const formData = new FormData(document.getElementById('consultationForm'));
      const data = {
        depuisQuand: formData.get('depuisQuand'),
        intensite: formData.get('intensite'),
        antecedents: formData.get('antecedents'),
        gene: formData.get('gene'),
        traitements: formData.getAll('traitements')
      };
      
      localStorage.setItem('consultationMemo', JSON.stringify(data));
      
      // Afficher confirmation
      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Sauvegardé !';
      saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
      saveBtn.classList.remove('bg-primary-600', 'hover:bg-primary-700');
      
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        saveBtn.classList.add('bg-primary-600', 'hover:bg-primary-700');
      }, 2000);
      
      updateApercu();
    }

    // Effacer les données
    function clearData() {
      if (confirm('Êtes-vous sûr de vouloir effacer toutes les données ?')) {
        localStorage.removeItem('consultationMemo');
        document.getElementById('consultationForm').reset();
        intensiteValue.textContent = '0';
        document.getElementById('apercu').classList.add('hidden');
      }
    }

    // Mise à jour de l'aperçu
    function updateApercu() {
      const formData = new FormData(document.getElementById('consultationForm'));
      const data = {
        depuisQuand: formData.get('depuisQuand'),
        intensite: formData.get('intensite'),
        antecedents: formData.get('antecedents'),
        gene: formData.get('gene'),
        traitements: formData.getAll('traitements')
      };
      
      if (data.depuisQuand || data.intensite || data.antecedents || data.gene || data.traitements.length > 0) {
        const apercu = document.getElementById('apercu');
        const apercuContent = document.getElementById('apercuContent');
        
        let html = '<div class="space-y-4">';
        
        if (data.depuisQuand) {
          html += `<div><strong>Depuis quand :</strong> ${data.depuisQuand}</div>`;
        }
        
        if (data.intensite && data.intensite !== '0') {
          html += `<div><strong>Intensité de la douleur :</strong> ${data.intensite}/10</div>`;
        }
        
        if (data.traitements.length > 0) {
          html += `<div><strong>Traitements essayés :</strong> ${data.traitements.join(', ')}</div>`;
        }
        
        if (data.antecedents) {
          html += `<div><strong>Antécédents & Allergies :</strong><br>${data.antecedents}</div>`;
        }
        
        if (data.gene) {
          html += `<div><strong>Gêne & Objectifs :</strong><br>${data.gene}</div>`;
        }
        
        html += '</div>';
        
        apercuContent.innerHTML = html;
        apercu.classList.remove('hidden');
      } else {
        document.getElementById('apercu').classList.add('hidden');
      }
    }

    // Impression
    function printMemo() {
      const apercu = document.getElementById('apercu');
      if (apercu.classList.contains('hidden')) {
        alert('Veuillez d\'abord remplir le formulaire et cliquer sur "Sauvegarder"');
        return;
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Mémo Consultation - Ma Santé Pied Cheville</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #0ea5e9; }
              .section { margin-bottom: 20px; }
              .label { font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>Mémo Consultation - Ma Santé Pied Cheville</h1>
            <p><strong>Date :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
            <hr>
            ${document.getElementById('apercuContent').innerHTML}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Event listeners
    document.getElementById('saveBtn').addEventListener('click', saveData);
    document.getElementById('clearBtn').addEventListener('click', clearData);
    document.getElementById('printBtn').addEventListener('click', printMemo);
    
    // Mise à jour de l'aperçu en temps réel
    document.getElementById('consultationForm').addEventListener('input', updateApercu);
    document.getElementById('consultationForm').addEventListener('change', updateApercu);

    // Charger les données au chargement de la page
    loadSavedData();
  </script>
</BaseLayout>
